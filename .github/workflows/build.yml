name: CI ğŸš¦
on:
  push:
    branches:
      - main
      - release-*
  pull_request:
env:
  build_java_version: 21
jobs:
  build:
    name: Build ğŸ“¦
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ“¥
        uses: actions/checkout@v6
      - name: Setup Java â˜•ï¸
        uses: actions/setup-java@v5.1.0
        with:
          distribution: zulu
          java-version: ${{ env.build_java_version }}
      - name: Setup Gradle ğŸ˜
        uses: gradle/actions/setup-gradle@v5
      - name: Spotless âœ¨
        run: ./gradlew spotlessCheck
      - name: Sanity Check ğŸ•Š
        run: ./gradlew rewriteDryRun
      - name: Build ğŸ—ï¸ 
        run: ./gradlew build
      - name: Verify No Modified Files ğŸ“‹
        run: |
          directoryState="$(git.status --porcelain)"
          if [ -n "$directoryState" ]; then
            echo "Some files were modified during build. Please run the build locally before checking in."
            echo "Modified files:"
            echo "$directoryState"
            exit 1
          fi
  test:
    name: Unit Tests ğŸ§ª (${{ matrix.os }} - JDK ${{ matrix.test_java_version }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        test_java_version: [8, 11, 17, 21]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout ğŸ“¥
        uses: actions/checkout@v6
      - name: Setup Build JDK â˜•
        uses: actions/setup-java@v5.1.0
        with:
          distribution: zulu
          java-version: ${{ env.build_java_version }}
      - name: Setup Test JDK â˜•
        uses: actions/setup-java@v5.1.0
        with:
          distribution: zulu
          java-version: ${{ matrix.test_java_version }}
      - name: Resolve Installed JDK Paths ğŸ”
        id: provideJdkPaths
        uses: actions/github-script@v8
        with:
          script: |
            for (let envVarName in process.env) {
              if (/JAVA_HOME_\d.*64/.test(envVarName)) {
                const version = envVarName.match(/JAVA_HOME_(\d+).*64/)[1];
                if (version === "${{ matrix.test_java_version }}") {
                  core.exportVariable("test_jdk_path", process.env[envVarName]);
                } else if (version === "${{ env.build_java_version }}") {
                  core.exportVariable("build_jdk_path", process.env[envVarName]);
                }
              }
            }
      - name: Setup Gradle ğŸ˜
        uses: gradle/actions/setup-gradle@v5
      - name: Run Tests ğŸ§ª
        run: ./gradlew test -PallTests -PtestJavaVersion=${{ matrix.test_java_version }} "-Porg.gradle.java.installations.paths=${{ env.test_jdk_path }}"
        env:
          JAVA_HOME: ${{ env.build_jdk_path }}
  integration-test:
    name: Integration Tests ğŸ§© (${{ matrix.os }} - JDK ${{ matrix.test_java_version }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        test_java_version: [8, 11, 17, 21]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout ğŸ“¥
        uses: actions/checkout@v6
      - name: Setup Build JDK â˜•
        uses: actions/setup-java@v5.1.0
        with:
          distribution: zulu
          java-version: ${{ env.build_java_version }}
      - name: Setup Test JDK â˜•
        uses: actions/setup-java@v5.1.0
        with:
          distribution: zulu
          java-version: ${{ matrix.test_java_version }}
      - name: Resolve Installed JDK Paths ğŸ”
        id: provideJdkPaths
        uses: actions/github-script@v8
        with:
          script: |
            for (let envVarName in process.env) {
              if (/JAVA_HOME_\d.*64/.test(envVarName)) {
                const version = envVarName.match(/JAVA_HOME_(\d+).*64/)[1];
                if (version === "${{ matrix.test_java_version }}") {
                  core.exportVariable("test_jdk_path", process.env[envVarName]);
                } else if (version === "${{ env.build_java_version }}") {
                  core.exportVariable("build_jdk_path", process.env[envVarName]);
                }
              }
            }
      - name: Setup Gradle ğŸ˜
        uses: gradle/actions/setup-gradle@v5
      - name: Publish to Maven Local ğŸ“¦
        run: ./gradlew build -xtest -xspotbugsMain -xjavadoc publishToMavenLocal
        env:
          JAVA_HOME: ${{ env.build_jdk_path }}
      - name: Run Integration Tests ğŸ§©
        run: ./gradlew runMavenTest -PtestJavaVersion=${{ matrix.test_java_version }} "-Porg.gradle.java.installations.paths=${{ env.test_jdk_path }}"
        env:
          JAVA_HOME: ${{ env.build_jdk_path }}
